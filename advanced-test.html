<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªÙ‚Ø¯Ù… Ù„Ù€ Flash Cards</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            direction: rtl;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
        }
        .card.known {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .card.unknown {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .card.loading {
            opacity: 0.6;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        button:hover {
            transform: translateY(-1px);
        }
        .toggle-btn {
            background-color: #007bff;
            color: white;
        }
        .toggle-btn:hover {
            background-color: #0056b3;
        }
        .refresh-btn {
            background-color: #28a745;
            color: white;
        }
        .clear-btn {
            background-color: #dc3545;
            color: white;
        }
        .test-btn {
            background-color: #17a2b8;
            color: white;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 5px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        .status-online {
            color: #28a745;
            font-weight: bold;
        }
        .status-offline {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªÙ‚Ø¯Ù… Ù„Ù€ Flash Cards API</h1>
        
        <div class="section">
            <h2>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</h2>
            <p>Ø­Ø§Ù„Ø© API: <span id="api-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span></p>
            <p>URL Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="current-url"></span></p>
        </div>

        <div class="section">
            <h2>Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div class="controls">
                <button class="refresh-btn" onclick="loadCards()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
                <button class="test-btn" onclick="runFullTest()">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„</button>
                <button class="clear-btn" onclick="clearLog()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                <button class="clear-btn" onclick="clearLocalStorage()">ğŸ’¾ Ù…Ø³Ø­ localStorage</button>
            </div>
        </div>

        <div class="section">
            <h2>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-cards">0</div>
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="known-cards">0</div>
                    <div>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unknown-cards">0</div>
                    <div>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="success-rate">0%</div>
                    <div>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h2>
            <div id="cards-container">
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>

        <div class="section">
            <h2>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
            <div id="log"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const logDiv = document.getElementById('log');
        let currentDecks = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logDiv.textContent = '';
            log('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„');
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('flashcards-decks');
            log('ØªÙ… Ù…Ø³Ø­ localStorage', 'warning');
        }
        
        // Ù…Ø­Ø§ÙƒØ§Ø© apiClient.js
        const json = (res) => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        };

        const tryApi = async (fn, fallback) => {
            try { 
                const result = await fn(); 
                return result;
            } catch (e) { 
                log(`API request failed: ${e.message}, using fallback`, 'warning');
                return fallback(); 
            }
        };

        const api = {
            listDecks: () => tryApi(
                async () => {
                    log('Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù† API...');
                    const response = await fetch(`${API_URL}/api/decks`);
                    const data = await json(response);
                    log(`ØªÙ… Ø¬Ù„Ø¨ ${data.length} Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† API`, 'success');
                    return data;
                },
                () => {
                    const raw = localStorage.getItem('flashcards-decks');
                    const data = raw ? JSON.parse(raw) : [];
                    log(`ØªÙ… Ø¬Ù„Ø¨ ${data.length} Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† localStorage`, 'warning');
                    return data;
                }
            ),
            toggleKnown: (deckId, cardId) => tryApi(
                async () => {
                    log(`ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${cardId} ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${deckId}...`);
                    const response = await fetch(`${API_URL}/api/decks/${deckId}/cards/${cardId}/toggle-known`, { 
                        method: 'POST' 
                    });
                    const result = await json(response);
                    log(`ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${result.data.known ? 'Ù…Ø­ÙÙˆØ¸' : 'ØºÙŠØ± Ù…Ø­ÙÙˆØ¸'}`, 'success');
                    return result;
                },
                () => {
                    log('ÙØ´Ù„ APIØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
                    return null;
                }
            ),
        };
        
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                const data = await response.json();
                document.getElementById('api-status').innerHTML = 
                    `<span class="status-online">Ù…ØªØµÙ„ âœ…</span> (${data.laravel_version})`;
                document.getElementById('current-url').textContent = API_URL;
                log('API Ù…ØªØ§Ø­ ÙˆÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
                return true;
            } catch (error) {
                document.getElementById('api-status').innerHTML = 
                    `<span class="status-offline">ØºÙŠØ± Ù…ØªØµÙ„ âŒ</span>`;
                document.getElementById('current-url').textContent = API_URL;
                log(`API ØºÙŠØ± Ù…ØªØ§Ø­: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function loadCards() {
            try {
                log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...');
                currentDecks = await api.listDecks();
                displayCards();
                updateStats();
                
                // Ø­ÙØ¸ ÙÙŠ localStorage
                if (currentDecks.length > 0) {
                    localStorage.setItem('flashcards-decks', JSON.stringify(currentDecks));
                    log(`ØªÙ… Ø­ÙØ¸ ${currentDecks.length} Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙŠ localStorage`, 'success');
                }
                
            } catch (error) {
                log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª: ${error.message}`, 'error');
            }
        }
        
        function displayCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            if (currentDecks.length === 0) {
                container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>';
                return;
            }
            
            let totalCards = 0;
            currentDecks.forEach(deck => {
                if (deck.cards && deck.cards.length > 0) {
                    totalCards += deck.cards.length;
                    
                    const deckDiv = document.createElement('div');
                    deckDiv.innerHTML = `<h3>ğŸ“š ${deck.title} (${deck.cards.length} Ø¨Ø·Ø§Ù‚Ø©)</h3>`;
                    container.appendChild(deckDiv);
                    
                    deck.cards.slice(0, 10).forEach(card => {  // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 10 Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙ‚Ø·
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `card ${card.known ? 'known' : 'unknown'}`;
                        cardDiv.id = `card-${card.id}`;
                        cardDiv.innerHTML = `
                            <h4>ğŸ—’ï¸ ${card.question}</h4>
                            <p><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</strong> ${card.answer}</p>
                            <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                                <span style="font-size: 14px;">
                                    ${card.known ? 'âœ… Ù…Ø­ÙÙˆØ¸' : 'âŒ ØºÙŠØ± Ù…Ø­ÙÙˆØ¸'} | 
                                    Ù…Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶: ${card.times_seen || 0} | 
                                    Ù…Ø±Ø§Øª Ø§Ù„Ø­ÙØ¸: ${card.times_known || 0}
                                </span>
                            </div>
                            <button class="toggle-btn" onclick="toggleKnown(${deck.id}, ${card.id}, ${card.known})">
                                ${card.known ? 'âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙØ¸' : 'âœ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©'}
                            </button>
                        `;
                        container.appendChild(cardDiv);
                    });
                    
                    if (deck.cards.length > 10) {
                        const moreDiv = document.createElement('div');
                        moreDiv.innerHTML = `<p style="text-align: center; color: #666;">... Ùˆ ${deck.cards.length - 10} Ø¨Ø·Ø§Ù‚Ø© Ø£Ø®Ø±Ù‰</p>`;
                        container.appendChild(moreDiv);
                    }
                }
            });
            
            if (totalCards === 0) {
                container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©</p>';
            }
        }
        
        function updateStats() {
            let totalCards = 0;
            let knownCards = 0;
            
            currentDecks.forEach(deck => {
                if (deck.cards) {
                    totalCards += deck.cards.length;
                    knownCards += deck.cards.filter(c => c.known).length;
                }
            });
            
            const unknownCards = totalCards - knownCards;
            const successRate = totalCards > 0 ? Math.round((knownCards / totalCards) * 100) : 0;
            
            document.getElementById('total-cards').textContent = totalCards;
            document.getElementById('known-cards').textContent = knownCards;
            document.getElementById('unknown-cards').textContent = unknownCards;
            document.getElementById('success-rate').textContent = `${successRate}%`;
        }
        
        async function toggleKnown(deckId, cardId, currentKnown) {
            const cardElement = document.getElementById(`card-${cardId}`);
            
            try {
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ø§Ù‹ (Optimistic Update)
                cardElement.className = `card loading`;
                log(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${cardId}...`);
                
                const result = await api.toggleKnown(deckId, cardId);
                
                if (result && result.data) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    const deck = currentDecks.find(d => d.id === deckId);
                    if (deck) {
                        const card = deck.cards.find(c => c.id === cardId);
                        if (card) {
                            card.known = result.data.known;
                            card.times_known = result.data.times_known;
                            card.times_seen = result.data.times_seen;
                        }
                    }
                    
                    // Ø­ÙØ¸ ÙÙŠ localStorage
                    localStorage.setItem('flashcards-decks', JSON.stringify(currentDecks));
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                    displayCards();
                    updateStats();
                    
                    log(`ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${result.data.known ? 'Ù…Ø­ÙÙˆØ¸' : 'ØºÙŠØ± Ù…Ø­ÙÙˆØ¸'}`, 'success');
                    
                } else {
                    // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ APIØŒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                    cardElement.className = `card ${currentKnown ? 'known' : 'unknown'}`;
                    log('ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©', 'error');
                }
                
            } catch (error) {
                // ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø£ØŒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                cardElement.className = `card ${currentKnown ? 'known' : 'unknown'}`;
                log(`Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${error.message}`, 'error');
            }
        }
        
        async function runFullTest() {
            log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„...', 'info');
            
            // 1. ÙØ­Øµ API
            log('1ï¸âƒ£ ÙØ­Øµ Ø­Ø§Ù„Ø© API...');
            const apiAvailable = await checkApiStatus();
            
            if (apiAvailable) {
                // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                log('2ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...');
                await loadCards();
                
                if (currentDecks.length > 0 && currentDecks[0].cards && currentDecks[0].cards.length > 0) {
                    const testCard = currentDecks[0].cards[0];
                    const originalState = testCard.known;
                    
                    // 3. Ø§Ø®ØªØ¨Ø§Ø± toggle
                    log(`3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${testCard.id}...`);
                    await toggleKnown(currentDecks[0].id, testCard.id, originalState);
                    
                    // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸
                    log('4ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª...');
                    await loadCards();
                    
                    const updatedCard = currentDecks[0].cards.find(c => c.id === testCard.id);
                    if (updatedCard && updatedCard.known !== originalState) {
                        log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'success');
                    } else {
                        log('âŒ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª!', 'error');
                    }
                    
                    // 5. Ø§Ø®ØªØ¨Ø§Ø± localStorage
                    log('5ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± localStorage...');
                    const localData = localStorage.getItem('flashcards-decks');
                    if (localData) {
                        const parsedLocal = JSON.parse(localData);
                        const localCard = parsedLocal[0]?.cards?.find(c => c.id === testCard.id);
                        if (localCard && localCard.known === updatedCard.known) {
                            log('âœ… localStorage Ù…ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'success');
                        } else {
                            log('âš ï¸ localStorage ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†!', 'warning');
                        }
                    }
                    
                } else {
                    log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ø§Ø®ØªØ¨Ø§Ø±Ù‡Ø§', 'warning');
                }
            }
            
            log('ğŸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„', 'info');
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', async () => {
            log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
            await checkApiStatus();
            await loadCards();
        });
    </script>
</body>
</html>
